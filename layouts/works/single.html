{{ define "main" }}
<article>
  {{ $type := .Params.entry_type | default "book" }}
  <span data-pagefind-meta="work_author" data-pagefind-ignore class="visually-hidden">{{ .Params.author }}</span>
  <span data-pagefind-meta="work_title" data-pagefind-ignore class="visually-hidden">{{ .Title }}</span>
  <span data-pagefind-meta="work_type" data-pagefind-ignore class="visually-hidden">{{ $type }}</span>
  {{ with .Plain }}<span data-pagefind-meta="work_abstract" data-pagefind-ignore class="visually-hidden">{{ . }}</span>{{ end }}

  <div class="work-header">
    {{ $url := .Params.external_url }}
    {{ if and (eq $type "online") $url (or (hasPrefix $url "https://") (hasPrefix $url "http://")) }}
    <h1><a href="{{ $url }}">{{ .Title | safeHTML }}</a></h1>
    {{ else }}
    <h1>{{ .Title | safeHTML }}</h1>
    {{ end }}

    {{/* Author / editor line */}}
    {{ if or (eq $type "collection") (eq $type "proceedings") }}
      {{ with .Params.editor }}
      <p class="work-author">{{ . }} {{ partial "editor-abbrev.html" . }}</p>
      {{ end }}
    {{ else }}
      {{ with .Params.author }}
      <p class="work-author">{{ . }}</p>
      {{ end }}
    {{ end }}

    {{/* Publication details line â€” entry-type branching mirrors citation-format.html;
         keep the two in sync when adding or modifying entry types */}}
    <p class="work-details">
      {{- if or (eq $type "incollection") (eq $type "inbook") (eq $type "inproceedings") -}}
        {{- with .Params.editor }}In {{ . }} {{ partial "editor-abbrev.html" . }}{{ end }} <em>{{ .Params.booktitle | default .Title | safeHTML }}</em>
        {{- with .Params.location }}, {{ . }}{{ end -}}
        {{- with .Params.year }}, {{ . }}{{ end -}}
        {{- with .Params.pages }}, pp. {{ . }}{{ end -}}
      {{- else if eq $type "article" -}}
        <em>{{ .Params.journaltitle | default .Title | safeHTML }}</em>
        {{- with .Params.volume }}, vol. {{ . }}{{ end -}}
        {{- with .Params.number }}, no. {{ . }}{{ end -}}
        {{- with .Params.year }}, {{ . }}{{ end -}}
        {{- with .Params.pages }}, pp. {{ . }}{{ end -}}
      {{- else if eq $type "online" -}}
        {{- with .Params.journaltitle }}<em>{{ . | safeHTML }}</em>{{ end -}}
        {{- if and .Params.pub_date (findRE `^\d{4}-\d{2}-\d{2}` .Params.pub_date) -}}
          {{- $d := time .Params.pub_date -}}
          {{- with .Params.journaltitle }}, {{ end -}}{{ $d.Format "January 2, 2006" -}}
        {{- else -}}
          {{- with .Params.year }}{{ with $.Params.journaltitle }}, {{ end }}{{ . }}{{ end -}}
        {{- end -}}
      {{- else -}}
        {{- $location := $.Params.location -}}
        {{- with $location }}{{ . }}{{ end -}}
        {{- with $.Params.year }}{{ if $location }}, {{ end }}{{ . }}{{ end -}}
      {{- end -}}
    </p>
  </div>

  {{ $workSlug := "" }}
  {{ with .File }}{{ $workSlug = .ContentBaseName }}{{ end }}

  {{ if not $workSlug }}{{ warnf "works/single: no .File for page %s" .Title }}{{ end }}

  {{ with .Content }}
    <div class="work-body">
      <h2>Abstract</h2>
      {{ . }}
    </div>
  {{ end }}

  {{ $thumbPath := printf "pdf-thumbnails/%s.png" $workSlug }}
  {{ $pdfPath := printf "pdfs/%s.pdf" $workSlug }}
  {{ if fileExists (printf "static/%s" $thumbPath) }}
  <section class="pdf-preview" aria-label="PDF preview">
    <h2>PDF</h2>
    <a href="/{{ $pdfPath }}" class="pdf-preview-link" target="_blank" rel="noopener">
      <img src="/{{ $thumbPath }}" alt="First page of PDF" loading="lazy" width="600">
    </a>
  </section>
  {{ end }}

  {{/* Citing notes data comes from data/citing-notes.json, generated by
       scripts/generate-citing-notes.py from cite shortcodes in content/notes/.
       Structure: { "work-slug": [{"slug": "...", "title": "..."}] } */}}
  {{ $citingNotes := index (.Site.Data | default dict) "citing-notes" }}
  {{ with $citingNotes }}
    {{ $entries := index . $workSlug }}
    {{ with $entries }}
    <section class="backlinks" aria-label="Citing notes" data-pagefind-ignore>
      <h2>Notes citing this work</h2>
      <ul>
        {{ range . }}
        <li><a href="/notes/{{ .slug }}/">{{ .title }}</a></li>
        {{ end }}
      </ul>
    </section>
    {{ end }}
  {{ end }}

  {{/* Find all quotes that cite this work */}}
  {{ $citingQuotes := where (where .Site.RegularPages "Section" "quotes") ".Params.work" $workSlug }}
  {{ with $citingQuotes }}
  <section class="backlinks" aria-label="Citing quotes" data-pagefind-ignore>
    <h2>Quotes from this work</h2>
    {{ range (sort . "Date" "desc") }}
      {{ partial "quote-entry.html" . }}
    {{ end }}
  </section>
  {{ end }}
</article>
{{ end }}

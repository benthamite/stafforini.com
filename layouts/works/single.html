{{ define "main" }}
<article>
  {{ $type := .Params.entry_type | default "book" }}
  <span data-pagefind-meta="work_author" data-pagefind-ignore class="visually-hidden">{{ .Params.author }}</span>
  <span data-pagefind-meta="work_title" data-pagefind-ignore class="visually-hidden">{{ .Title }}</span>
  {{ with .Plain }}<span data-pagefind-meta="work_abstract" data-pagefind-ignore class="visually-hidden">{{ . }}</span>{{ end }}
  <h1>
    {{- partial "citation-format.html" (dict "work" . "type" $type "link" false) -}}
  </h1>

  {{ with .Content }}
    <div class="work-body">{{ . }}</div>
  {{ end }}

  {{ $workSlug := "" }}
  {{ with .File }}{{ $workSlug = .ContentBaseName }}{{ end }}

  {{/* Find all quotes that cite this work */}}
  {{ $citingQuotes := where (where .Site.RegularPages "Section" "quotes") ".Params.work" $workSlug }}
  {{ with $citingQuotes }}
  <section class="backlinks" aria-label="Citing quotes" data-pagefind-ignore>
    <h2>Quotes from this work</h2>
    {{ range (sort . "Date" "desc") }}
      {{ partial "quote-entry.html" . }}
    {{ end }}
  </section>
  {{ end }}

  {{/* Find all notes that cite this work */}}
  {{ $citingNotes := slice }}
  {{ range where .Site.RegularPages "Section" "notes" }}
    {{ if in .Params.works $workSlug }}
      {{ $citingNotes = $citingNotes | append . }}
    {{ end }}
  {{ end }}
  {{ with $citingNotes }}
  <section class="backlinks" aria-label="Citing notes" data-pagefind-ignore>
    <h2>Notes citing this work</h2>
    <ul>
      {{ range (sort . "Title") }}
      <li><a href="{{ .RelPermalink }}">{{ .Title | safeHTML }}</a></li>
      {{ end }}
    </ul>
  </section>
  {{ end }}
</article>
{{ end }}

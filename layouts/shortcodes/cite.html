{{/*
  Render an org-cite reference as a formatted citation with link to work page.

  Usage (emitted by export-notes.el cite processor):
    {{< cite "Parfit2017WhatMattersVolume" >}}
    {{< cite "Broad1952EthicsHistoryPhilosophy" "pp. 3–28" >}}

  First arg: cite key (CamelCase, as in the bib file)
  Second arg (optional): locator (page/chapter reference)

  Converts cite key to kebab-case slug, looks up the work page,
  and renders the citation using the shared citation-format partial.
*/}}

{{- $key := .Get 0 -}}
{{- $locator := .Get 1 -}}

{{/* Convert CamelCase cite key to kebab-case slug:
     Parfit2017WhatMattersVolume → parfit-2017-what-matters-volume */}}
{{- $slug := $key -}}
{{- $slug = replaceRE "([a-zA-Z])(\\d)" "${1}-${2}" $slug -}}
{{- $slug = replaceRE "(\\d)([a-zA-Z])" "${1}-${2}" $slug -}}
{{- $slug = replaceRE "([a-z])([A-Z])" "${1}-${2}" $slug -}}
{{- $slug = lower $slug -}}

{{- $work := site.GetPage (printf "/works/%s" $slug) -}}
{{- if $work -}}
  {{- $type := $work.Params.entry_type | default "book" -}}
  {{- partial "citation-format.html" (dict "work" $work "type" $type "locator" $locator "link" true) -}}
{{- else -}}
  {{/* Fallback: render the raw key as a span for easy identification */}}
  <span class="cite-unresolved" title="No work page found for {{ $key }}">{{ $key }}</span>
{{- end -}}

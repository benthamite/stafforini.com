{{ define "main" }}
<h1>Search results</h1>

<div class="search-page">
  <div class="search-box">
    <label for="search-page-input" class="visually-hidden">Search</label>
    <input type="text" id="search-page-input" class="search-input" placeholder="Search..." autocomplete="off" />
  </div>
  <div id="search-page-results" class="search-results search-results-page"></div>
</div>

<script type="module">
  var input = document.getElementById('search-page-input');
  var resultsEl = document.getElementById('search-page-results');
  var debounceTimer = null;
  var searchGeneration = 0;

  var core = window._searchCore;
  var nav = window._searchUtils.createKeyboardNav(resultsEl, input);

  var pagefind = null;
  try {
    pagefind = await import('/pagefind/pagefind.js');
    await pagefind.init();
  } catch (e) {
    resultsEl.innerHTML = '<p class="search-no-results">Search is unavailable. Please try again later.</p>';
  }

  function doSearch(query, filterSection) {
    core.runSearch(query, pagefind, {
      maxResultsPerSection: 0,
      filterSection: filterSection || undefined,
      onResults: function(html) { resultsEl.innerHTML = html; nav.refresh(); },
      getGeneration: function() { return searchGeneration; },
      incrementGeneration: function() { return ++searchGeneration; }
    });
  }

  input.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(function() {
      var params = new URLSearchParams(window.location.search);
      params.set('q', input.value.trim());
      history.replaceState(null, '', '?' + params.toString());
      doSearch(input.value.trim(), params.get('section'));
    }, core.SEARCH_DEBOUNCE_MS);
  });

  // Read query params on load
  var params = new URLSearchParams(window.location.search);
  var q = params.get('q');
  var sec = params.get('section');
  if (q) {
    input.value = q;
    doSearch(q, sec);
  }
  input.focus();
</script>
{{ end }}

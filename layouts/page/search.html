{{ define "main" }}
<h1>Search results</h1>

<div class="search-page">
  <div class="search-box">
    <label for="search-page-input" class="visually-hidden">Search</label>
    <input type="text" id="search-page-input" class="search-input" placeholder="Search..." autocomplete="off" />
  </div>
  <div id="search-page-results" class="search-results search-results-page"></div>
</div>

<script type="module">
  var input = document.getElementById('search-page-input');
  var resultsEl = document.getElementById('search-page-results');
  var debounceTimer = null;
  var searchGeneration = 0;

  var sections = [
    { key: 'notes', label: 'Notes' },
    { key: 'quotes', label: 'Quotes' },
    { key: 'works', label: 'Works' }
  ];

  var pagefind = null;
  try {
    pagefind = await import('/pagefind/pagefind.js');
    await pagefind.init();
  } catch (e) {
    resultsEl.innerHTML = '<p class="search-no-results">Search is unavailable. Please try again later.</p>';
  }

  var utils = window._searchUtils;
  var currentQuery = '';

  async function runSearch(query, filterSection) {
    var gen = ++searchGeneration;
    currentQuery = query;
    if (!query || !pagefind) {
      resultsEl.innerHTML = '';
      return;
    }

    var searchSections = filterSection
      ? sections.filter(function(s) { return s.key === filterSection; })
      : sections;

    var html = '';
    for (var i = 0; i < searchSections.length; i++) {
      var sec = searchSections[i];
      var search = await pagefind.search(query, {
        filters: { section: [sec.key] }
      });

      if (gen !== searchGeneration) return;

      if (search.results.length === 0) continue;

      var results = await Promise.all(search.results.map(function(r) { return r.data(); }));

      if (gen !== searchGeneration) return;

      html += '<div class="search-section">';
      html += '<h3 class="search-section-heading">' + sec.label + ' (' + results.length + ')</h3>';
      html += '<ul class="search-section-list">';
      for (var j = 0; j < results.length; j++) {
        html += utils.renderResult(results[j], sec.key, currentQuery);
      }
      html += '</ul>';
      html += '</div>';
    }

    if (gen !== searchGeneration) return;

    if (!html) {
      html = '<p class="search-no-results">No results found.</p>';
    }

    resultsEl.innerHTML = html;
  }

  input.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(function() {
      var params = new URLSearchParams(window.location.search);
      params.set('q', input.value.trim());
      history.replaceState(null, '', '?' + params.toString());
      runSearch(input.value.trim(), params.get('section'));
    }, 200);
  });

  // Read query params on load
  var params = new URLSearchParams(window.location.search);
  var q = params.get('q');
  var sec = params.get('section');
  if (q) {
    input.value = q;
    runSearch(q, sec);
  }
  input.focus();
</script>
{{ end }}

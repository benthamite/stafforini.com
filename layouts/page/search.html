{{ define "main" }}
<h1>Search results</h1>

<div class="search-page">
  <div class="search-box">
    <input type="text" id="search-page-input" class="search-input" placeholder="Search..." autocomplete="off" />
  </div>
  <div id="search-page-results" class="search-results search-results-page"></div>
</div>

<script type="module">
  var input = document.getElementById('search-page-input');
  var resultsEl = document.getElementById('search-page-results');
  var debounceTimer = null;

  var sections = [
    { key: 'notes', label: 'Notes' },
    { key: 'quotes', label: 'Quotes' },
    { key: 'works', label: 'Works' }
  ];

  var pagefind = await import('/pagefind/pagefind.js');
  await pagefind.init();

  function escapeHtml(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function renderResult(r) {
    var label;
    if (r.meta.work_author && r.meta.work_title) {
      label = escapeHtml(r.meta.work_author) + ', <em>' + escapeHtml(r.meta.work_title) + '</em>';
    } else {
      label = escapeHtml(r.meta.title || r.url);
    }
    var html = '<li><a href="' + escapeHtml(r.url) + '">' + label + '</a>';
    if (r.excerpt) html += '<p class="search-excerpt">' + r.excerpt + '</p>';
    html += '</li>';
    return html;
  }

  async function runSearch(query, filterSection) {
    if (!query) {
      resultsEl.innerHTML = '';
      return;
    }

    var searchSections = filterSection
      ? sections.filter(function(s) { return s.key === filterSection; })
      : sections;

    var html = '';
    for (var i = 0; i < searchSections.length; i++) {
      var sec = searchSections[i];
      var search = await pagefind.search(query, {
        filters: { section: [sec.key] }
      });

      if (search.results.length === 0) continue;

      // Deduplicate by ID
      var seen = {};
      var unique = [];
      for (var k = 0; k < search.results.length; k++) {
        var id = search.results[k].id;
        if (!seen[id]) {
          seen[id] = true;
          unique.push(search.results[k]);
        }
      }

      var results = await Promise.all(unique.map(function(r) { return r.data(); }));

      html += '<div class="search-section">';
      html += '<h3 class="search-section-heading">' + sec.label + ' (' + results.length + ')</h3>';
      html += '<ul class="search-section-list">';
      for (var j = 0; j < results.length; j++) {
        html += renderResult(results[j]);
      }
      html += '</ul>';
      html += '</div>';
    }

    if (!html) {
      html = '<p class="search-no-results">No results found.</p>';
    }

    resultsEl.innerHTML = html;
  }

  input.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(function() {
      var params = new URLSearchParams(window.location.search);
      params.set('q', input.value.trim());
      history.replaceState(null, '', '?' + params.toString());
      runSearch(input.value.trim(), params.get('section'));
    }, 200);
  });

  // Read query params on load
  var params = new URLSearchParams(window.location.search);
  var q = params.get('q');
  var sec = params.get('section');
  if (q) {
    input.value = q;
    runSearch(q, sec);
  }
  input.focus();
</script>
{{ end }}

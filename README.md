# stafforini.com

Source code for [stafforini.com](https://stafforini.com/), a personal digital garden built with [Hugo](https://gohugo.io/).

The site has three content sections:

- **Notes** — a wiki-like collection of interlinked notes, organized using a backlinks-as-taxonomy approach (instead of tags/categories, notes link to each other, and the backlink graph serves as the organizational structure)
- **Quotes** — a reverse-chronological diary of quotes from books, articles, and other sources
- **Works** — bibliographic entries for cited works, auto-generated from BibTeX data

## Features

- **Backlinks** — org-roam-powered link graph with "links to this note" sections, replacing traditional tags and categories
- **Client-side search** — [Pagefind](https://pagefind.app/) WebAssembly search with section faceting, keyboard navigation, and a header overlay triggered by `/` or `Cmd+K`
- **Citations** — org-cite references rendered via a custom Hugo shortcode, with formatted output by BibTeX entry type (book, article, incollection, etc.)
- **Link previews** — Wikipedia-style hover popups showing the first paragraph of linked notes
- **Sidenotes** — footnotes displayed as margin notes on wide viewports, falling back to standard footnotes on narrow screens
- **Dark mode** — three-state toggle (light / dark / system) with `localStorage` persistence and `prefers-color-scheme` support
- **Math rendering** — KaTeX, conditionally loaded only on pages that use math
- **Table of contents** — floating sidebar TOC with scroll spy on wide viewports; inline collapsible TOC on narrower screens
- **PDF previews** — first-page thumbnail images on work pages, linking to full PDFs
- **RSS feeds** — full-content feeds for both notes and quotes

## Tech stack

| Component | Choice |
|---|---|
| Static site generator | [Hugo](https://gohugo.io/) (extended edition) |
| Content authoring | [Org-mode](https://orgmode.org/) + [ox-hugo](https://ox-hugo.scripter.co/) |
| Note graph | [Org-roam](https://www.orgroam.com/) |
| Citations | [Org-cite](https://orgmode.org/manual/Citations.html) + CSL |
| Search | [Pagefind](https://pagefind.app/) |
| Math | [KaTeX](https://katex.org/) |
| Typography | [Source Serif 4](https://github.com/adobe-fonts/source-serif) (self-hosted, variable) |
| Hosting | [Netlify](https://www.netlify.com/) |

No JavaScript frameworks — all client-side code is vanilla JS. CSS is processed via Hugo Pipes (concatenated, minified, fingerprinted).

## Project structure

```
stafforini.com/
├── archetypes/            # Hugo content templates
├── assets/
│   ├── css/               # CSS partials (base, layout, components, dark mode, etc.)
│   └── js/                # JS modules (search, dark mode, TOC, sidenotes, link preview)
├── content/               # GITIGNORED — generated by ox-hugo export
├── data/
│   ├── backlinks.json     # Note-to-note backlink reverse index
│   └── citing-notes.json  # Work-to-note citation reverse index
├── layouts/
│   ├── _default/          # Base template, RSS, math render hooks
│   ├── notes/             # Note list and single templates
│   ├── quotes/            # Quote list and single templates
│   ├── works/             # Work list and single templates
│   ├── partials/          # Shared partials (head, header, footer, backlinks, etc.)
│   └── shortcodes/        # cite, gallery
├── scripts/               # Python, Bash, and Emacs Lisp build scripts
├── static/
│   ├── fonts/             # Source Serif 4 (WOFF2)
│   └── images/            # Image galleries
├── hugo.toml              # Main Hugo config
├── hugo.dev.toml          # Dev overlay (excludes heavy static dirs)
├── netlify.toml           # Headers, redirects, CSP
├── long.csl               # CSL citation style
└── package.json           # npm scripts + Pagefind dependency
```

The `content/` directory is gitignored — it is generated from org-mode source files via ox-hugo and deployed to Netlify separately. See [Content workflow](#content-workflow) below.

## Prerequisites

- [Hugo](https://gohugo.io/) extended edition (v0.151.2+)
- [Node.js](https://nodejs.org/) (v20+)
- [Python 3](https://www.python.org/) with `pikepdf` and `Pillow`
- [Emacs](https://www.gnu.org/software/emacs/) with [ox-hugo](https://ox-hugo.scripter.co/) and [org-roam](https://www.orgroam.com/) (for content export)
- [MuPDF tools](https://mupdf.com/) (`mutool`, for PDF thumbnail generation)
- [Netlify CLI](https://docs.netlify.com/cli/get-started/) (for deployment)

On macOS with Homebrew:

```bash
brew install hugo node python mupdf-tools
pip install pikepdf Pillow
npm install -g netlify-cli
```

## Getting started

```bash
npm install        # install Pagefind
npm run dev        # start the Hugo dev server at localhost:1313
```

The dev server uses `hugo.dev.toml` to exclude heavy static directories (PDFs, thumbnails) for fast startup.

## Content workflow

All content is authored in org-mode and exported to Hugo-compatible markdown via ox-hugo:

1. **Notes** are exported from org files in `~/Library/CloudStorage/Dropbox/websites/pablos-miscellany/`
2. **Quotes** are exported from org files in `~/Library/CloudStorage/Dropbox/bibliographic-notes/`
3. **Works** are generated by `scripts/generate-work-pages.py` from BibTeX data

The build pipeline:

```
Org files → ox-hugo export → content/*.md → Hugo build → Pagefind index → Netlify deploy
```

### Key scripts

| Script | Purpose |
|---|---|
| `export-notes.sh` | Incremental note export + lastmod injection + backlinks + citing-notes |
| `export-quotes.sh` | Incremental quote export + ID-slug map + work pages + topic pages |
| `generate-backlinks.py` | Queries org-roam SQLite DB, builds `data/backlinks.json` |
| `generate-citing-notes.py` | Scans notes for cite shortcodes, builds `data/citing-notes.json` |
| `generate-work-pages.py` | Creates work pages from BibTeX data |
| `process-pdfs.py` | Strips annotations, generates first-page thumbnails |
| `prepare-org-notes.py` | Adds ox-hugo metadata to new org files |
| `deploy.sh` | Full build + Netlify deploy |
| `start-dev-server.sh` | Starts the Hugo dev server |
| `build-search-index.sh` | Builds Hugo + runs Pagefind |

### npm scripts

```bash
npm run build      # hugo --minify && npx pagefind --site public
npm run dev        # start dev server
npm run reindex    # rebuild search index
npm run index      # run Pagefind only
```

## Deployment

Deploys are manual — there is no CI/CD from git pushes. The deploy script builds locally and pushes to Netlify via CLI:

```bash
bash scripts/deploy.sh
```

## Companion Emacs package

The [`stafforini.el`](https://github.com/benthamite/stafforini.el) package provides Emacs commands for the full build pipeline, accessible via `stafforini-menu`. It wraps the scripts in this repo with convenient interactive commands for exporting, rebuilding, and deploying.

## Design

The site follows a minimalist, academic aesthetic inspired by [Gwern.net](https://gwern.net/) and [Andy Matuschak's working notes](https://notes.andymatuschak.org/):

- Serif typography (Source Serif 4) with a comfortable reading width (~65–75 characters)
- Single-column centered layout, no sidebar
- Muted color palette, light background by default
- Responsive design with progressive enhancement
- WCAG AA accessibility (semantic HTML, keyboard navigation, focus indicators, `prefers-reduced-motion` support)
- Strong security headers (CSP, X-Frame-Options, etc.)

## License

All rights reserved. The source code is provided for reference only.

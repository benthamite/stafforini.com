[build]
command = "echo 'ERROR: Builds are deployed via scripts/deploy.sh, not Netlify CI.' && exit 1"
publish = "public"

[build.environment]
HUGO_VERSION = "0.151.2"
NODE_VERSION = "20"

[[headers]]
for = "/*"
  [headers.values]
  X-Frame-Options = "DENY"
  X-Content-Type-Options = "nosniff"
  Referrer-Policy = "strict-origin-when-cross-origin"
  Permissions-Policy = "camera=(), microphone=(), geolocation=()"
  # Content-Security-Policy breakdown:
  #   default-src 'self'          — only load resources from this origin by default
  #   script-src  'unsafe-inline' — required for Hugo's inline dark-mode script (FOUC prevention)
  #               'wasm-unsafe-eval' — required for Pagefind's WebAssembly search engine
  #                cdn.jsdelivr.net — KaTeX JS
  #   style-src   'unsafe-inline' — required for KaTeX inline styles
  #                cdn.jsdelivr.net — KaTeX CSS
  #   font-src    'self'          — only local fonts (Source Serif 4)
  #   img-src     'self' data:    — data: URIs used by KaTeX for rendering
  #   connect-src 'self'          — Pagefind search fetches index fragments via fetch()
  Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; font-src 'self'; img-src 'self' data:; media-src 'self'; connect-src 'self'"

[[headers]]
for = "/fonts/*"
  [headers.values]
  Cache-Control = "public, max-age=31536000, immutable" # 1 year in seconds

# RSS feed redirects (preserve subscribers from WordPress)
[[redirects]]
from = "/blog/feed/"
to = "/notes/index.xml"
status = 301

[[redirects]]
from = "/blog/feed"
to = "/notes/index.xml"
status = 301

[[redirects]]
from = "/tango/feed/"
to = "/notes/index.xml"
status = 301

[[redirects]]
from = "/tango/feed"
to = "/notes/index.xml"
status = 301

[[redirects]]
from = "/quotes/"
query = { feed = "rss2" }
to = "/quotes/index.xml"
status = 301

# General blog → notes redirect
[[redirects]]
from = "/blog/*"
to = "/notes/:splat"
status = 301
